version: '3.8'

services:
    # MongoDB Database
    mongodb:
        image: mongo:7.0
        container_name: tarkeba-mongodb
        restart: unless-stopped
        environment:
            MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-admin}
            MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-password}
            MONGO_INITDB_DATABASE: ${MONGO_DATABASE:-tarkeba}
        ports:
            - '${MONGO_PORT:-27017}:27017'
        volumes:
            - mongodb_data:/data/db
            - ./docker/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
        networks:
            - tarkeba-network
        healthcheck:
            test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    # Redis Cache (Optional)
    redis:
        image: redis:7.2-alpine
        container_name: tarkeba-redis
        restart: unless-stopped
        command: redis-server --requirepass ${REDIS_PASSWORD:-password}
        ports:
            - '${REDIS_PORT:-6379}:6379'
        volumes:
            - redis_data:/data
        networks:
            - tarkeba-network
        healthcheck:
            test: ['CMD', 'redis-cli', '--raw', 'incr', 'ping']
            interval: 30s
            timeout: 10s
            retries: 3

    # NestJS Application
    app:
        build:
            context: .
            dockerfile: Dockerfile
            target: production
        container_name: tarkeba-app
        restart: unless-stopped
        environment:
            NODE_ENV: ${NODE_ENV:-production}
            PORT: ${PORT:-3000}

            # Database
            MONGODB_URI: mongodb://${MONGO_ROOT_USERNAME:-admin}:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/${MONGO_DATABASE:-tarkeba}?authSource=admin

            # Redis
            REDIS_URL: redis://:${REDIS_PASSWORD:-password}@redis:6379

            # JWT
            ACCESS_JWT_SECRET: ${ACCESS_JWT_SECRET}
            ACCESS_JWT_EXPIRY: ${ACCESS_JWT_EXPIRY:-15m}
            REFRESH_JWT_SECRET: ${REFRESH_JWT_SECRET}
            REFRESH_JWT_EXPIRY: ${REFRESH_JWT_EXPIRY:-7d}
            RESET_JWT_EXPIRY: ${RESET_JWT_EXPIRY:-30m}
            JWT_ISSUER: ${JWT_ISSUER}
            JWT_AUDIENCE: ${JWT_AUDIENCE}

            # OAuth
            GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
            GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
            GOOGLE_CALLBACK_URL: ${GOOGLE_CALLBACK_URL:-/auth/google/callback}

            FACEBOOK_CLIENT_ID: ${FACEBOOK_CLIENT_ID}
            FACEBOOK_CLIENT_SECRET: ${FACEBOOK_CLIENT_SECRET}
            FACEBOOK_CALLBACK_URL: ${FACEBOOK_CALLBACK_URL:-/auth/facebook/callback}

            # Paymob
            PAYMOB_API_KEY: ${PAYMOB_API_KEY}
            PAYMOB_BASE_URL: ${PAYMOB_BASE_URL:-https://accept.paymob.com/api}
            PAYMOB_VISA_INTEGRATION_ID: ${PAYMOB_VISA_INTEGRATION_ID}
            PAYMOB_MASTERCARD_INTEGRATION_ID: ${PAYMOB_MASTERCARD_INTEGRATION_ID}
            PAYMOB_VODAFONE_CASH_INTEGRATION_ID: ${PAYMOB_VODAFONE_CASH_INTEGRATION_ID}
            PAYMOB_ORANGE_CASH_INTEGRATION_ID: ${PAYMOB_ORANGE_CASH_INTEGRATION_ID}
            PAYMOB_ETISALAT_CASH_INTEGRATION_ID: ${PAYMOB_ETISALAT_CASH_INTEGRATION_ID}
            PAYMOB_WE_PAY_INTEGRATION_ID: ${PAYMOB_WE_PAY_INTEGRATION_ID}
            PAYMOB_IFRAME_ID: ${PAYMOB_IFRAME_ID}
            PAYMOB_HMAC_SECRET: ${PAYMOB_HMAC_SECRET}

            # Email
            EMAIL_PROVIDER: ${EMAIL_PROVIDER:-smtp}
            SMTP_HOST: ${SMTP_HOST}
            SMTP_PORT: ${SMTP_PORT:-587}
            SMTP_USER: ${SMTP_USER}
            SMTP_PASS: ${SMTP_PASS}
            EMAIL_FROM_NAME: ${EMAIL_FROM_NAME:-Tarkeba}
            EMAIL_FROM_ADDRESS: ${EMAIL_FROM_ADDRESS}

            # File Storage
            STORAGE_PROVIDER: ${STORAGE_PROVIDER:-local}
            UPLOAD_PATH: ${UPLOAD_PATH:-./uploads}
            MAX_FILE_SIZE: ${MAX_FILE_SIZE:-5242880}

            # App
            APP_URL: ${APP_URL:-http://localhost:3000}
            FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3001}
            CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3001}

        ports:
            - '${PORT:-3000}:3000'
        volumes:
            - ./uploads:/app/uploads
            - ./logs:/app/logs
        networks:
            - tarkeba-network
        depends_on:
            mongodb:
                condition: service_healthy
            redis:
                condition: service_healthy
        healthcheck:
            test: ['CMD', 'curl', '-f', 'http://localhost:3000/health']
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    # Nginx Reverse Proxy (Optional)
    nginx:
        image: nginx:alpine
        container_name: tarkeba-nginx
        restart: unless-stopped
        ports:
            - '80:80'
            - '443:443'
        volumes:
            - ./docker/nginx.conf:/etc/nginx/nginx.conf:ro
            - ./docker/ssl:/etc/nginx/ssl:ro
        networks:
            - tarkeba-network
        depends_on:
            - app
        profiles:
            - production

volumes:
    mongodb_data:
        driver: local
    redis_data:
        driver: local

networks:
    tarkeba-network:
        driver: bridge
