version: '3.8'

services:
    # MongoDB Database
    mongodb:
        image: mongo:7.0
        container_name: tarkeba-mongodb
        restart: unless-stopped
        environment:
            MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-admin}
            MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-password}
            MONGO_INITDB_DATABASE: ${MONGO_DATABASE:-tarkeba}
        ports:
            - '${MONGO_PORT:-27017}:27017'
        volumes:
            - mongodb_data:/data/db
            - ./docker/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
        networks:
            - tarkeba-network
        healthcheck:
            test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    # Redis Cache (Optional)
    redis:
        image: redis:7.2-alpine
        container_name: tarkeba-redis
        restart: unless-stopped
        command: redis-server --requirepass ${REDIS_PASSWORD:-password}
        ports:
            - '${REDIS_PORT:-6379}:6379'
        volumes:
            - redis_data:/data
        networks:
            - tarkeba-network
        healthcheck:
            test: ['CMD', 'redis-cli', '--raw', 'incr', 'ping']
            interval: 30s
            timeout: 10s
            retries: 3

    # NestJS Application
    app:
        build:
            context: .
            dockerfile: Dockerfile
            target: production
        container_name: tarkeba-app
        restart: unless-stopped
        environment:
            NODE_ENV: ${NODE_ENV:-production}
            PORT: ${PORT:-5000}

            # Database
            MONGODB_URI: mongodb://${MONGO_ROOT_USERNAME:-admin}:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/${MONGO_DATABASE:-tarkeba}?authSource=admin

            # Redis
            REDIS_URL: redis://:${REDIS_PASSWORD:-password}@redis:6379

            # JWT
            ACCESS_JWT_SECRET: ${ACCESS_JWT_SECRET}
            ACCESS_JWT_EXPIRY: ${ACCESS_JWT_EXPIRY:-15m}
            REFRESH_JWT_SECRET: ${REFRESH_JWT_SECRET}
            REFRESH_JWT_EXPIRY: ${REFRESH_JWT_EXPIRY:-7d}
            RESET_JWT_EXPIRY: ${RESET_JWT_EXPIRY:-30m}
            JWT_ISSUER: ${JWT_ISSUER}
            JWT_AUDIENCE: ${JWT_AUDIENCE}

            # OAuth
            GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
            GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
            GOOGLE_CALLBACK_URL: ${GOOGLE_CALLBACK_URL:-http://localhost:3000/api/auth/google/callback}
            GOOGLE_SECRET: ${GOOGLE_SECRET}

            # Paymob
            PAYMOB_API_KEY: ${PAYMOB_API_KEY}
            PAYMOB_BASE_URL: ${PAYMOB_BASE_URL:-https://accept.paymob.com/api}
            PAYMOB_SECRET_URL: ${PAYMOB_SECRET_URL}
            PAYMOB_PUBLIC_URL: ${PAYMOB_PUBLIC_URL}
            PAYMOB_WALLET_INTEGRATION_ID: ${PAYMOB_WALLET_INTEGRATION_ID}
            PAYMOB_HMAC_SECRET: ${PAYMOB_HMAC_SECRET}

            # Email
            EMAIL_PROVIDER: ${EMAIL_PROVIDER:-smtp}
            MAIL_HOST: ${MAIL_HOST}
            MAIL_PORT: ${MAIL_PORT:-587}
            MAIL_SECURE: ${MAIL_SECURE:-false}
            MAIL_USER: ${MAIL_USER}
            MAIL_PASSWORD: ${MAIL_PASSWORD}
            MAIL_FROM_NAME: ${MAIL_FROM_NAME:-Tarkeba E-commerce}
            MAIL_FROM: ${MAIL_FROM}

            # File Storage
            STORAGE_PROVIDER: ${STORAGE_PROVIDER:-local}
            CLOUDINARY_CLOUD_NAME: ${CLOUDINARY_CLOUD_NAME}
            CLOUDINARY_API_KEY: ${CLOUDINARY_API_KEY}
            CLOUDINARY_API_SECRET: ${CLOUDINARY_API_SECRET}

            # Security
            BCRYPT_ROUNDS: ${BCRYPT_ROUNDS:-12}
            SESSION_SECRET: ${SESSION_SECRET}

            # Rate Limiting
            RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-900000}
            RATE_LIMIT_MAX_REQUESTS: ${RATE_LIMIT_MAX_REQUESTS:-1000}
            THROTTLE_SKIP_KEY: ${THROTTLE_SKIP_KEY}

            # Logging
            LOG_LEVEL: ${LOG_LEVEL:-info}
            LOG_FILE_PATH: ${LOG_FILE_PATH:-./logs/app.log}

            # Queue Configuration
            AGENDA_DB_COLLECTION: ${AGENDA_DB_COLLECTION:-agendaJobs}
            AGENDA_MAX_CONCURRENCY: ${AGENDA_MAX_CONCURRENCY:-20}

            # Health Check
            HEALTH_CHECK_TIMEOUT: ${HEALTH_CHECK_TIMEOUT:-5000}

            # App
            APP_URL: ${APP_URL:-http://localhost:5000}
            FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
            CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3000}

        ports:
            - '${PORT:-3000}:3000'
        volumes:
            - ./uploads:/app/uploads
            - ./logs:/app/logs
        networks:
            - tarkeba-network
        depends_on:
            mongodb:
                condition: service_healthy
            redis:
                condition: service_healthy
        healthcheck:
            test: ['CMD', 'curl', '-f', 'http://localhost:3000/health']
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

    # Nginx Reverse Proxy (Optional)
    nginx:
        image: nginx:alpine
        container_name: tarkeba-nginx
        restart: unless-stopped
        ports:
            - '80:80'
            - '443:443'
        volumes:
            - ./docker/nginx.conf:/etc/nginx/nginx.conf:ro
            - ./docker/ssl:/etc/nginx/ssl:ro
        networks:
            - tarkeba-network
        depends_on:
            - app
        profiles:
            - production

volumes:
    mongodb_data:
        driver: local
    redis_data:
        driver: local

networks:
    tarkeba-network:
        driver: bridge
